# Default values for redeployer.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

image:
  repository: bitnami/kubectl
  pullPolicy: Always
  # Overrides the image tag whose default is the chart appVersion.
  tag: latest

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

role:
  name: restart-deployment
  apiGroups:
    - apps
    - extensions
  resources:
    - deployments
  resourceNames:
    - sonarr
    - radarr
    - prowlarr
    - transmission
    - monitorr
    - overseerr
    - tautulli
    - organizr
    - plex
  verbs:
    - get
    - list
    - patch

jobs:
  - name: sonarr
    command: kubectl -n media rollout restart deployment sonarr
    schedule: "0 4 * * *"
  - name: radarr
    command: kubectl -n media rollout restart deployment radarr
    schedule: "0 4 * * *"
  - name: prowlarr
    command: kubectl -n media rollout restart deployment prowlarr
    schedule: "0 4 * * *"
  - name: transmission
    command: kubectl -n media rollout restart deployment transmission
    schedule: "0 4 * * *"
  - name: monitorr
    command: kubectl -n media rollout restart deployment monitorr
    schedule: "0 4 * * *"
  - name: overseerr
    command: kubectl -n media rollout restart deployment overseerr
    schedule: "0 4 * * *"
  - name: tautulli
    command: kubectl -n media rollout restart deployment tautulli
    schedule: "0 4 * * *"
  - name: organizr
    command: kubectl -n media rollout restart deployment organizr
    schedule: "0 4 * * *"
  - name: plex
    command: kubectl -n media rollout restart deployment plex
    schedule: "0 4 * * *"
  - name: rebalanace-plex
    schedule: "* * * * *"
    command: |
      #!/bin/bash

      quicksync_available=$(kubectl get node k8s-control-3 | tail -n 1 | tr -s ' ' | cut -d ' ' -f 2)
      current_node=$(kubectl -n media get pods -l app.kubernetes.io/name=plex -o=wide | tail -n 1 | tr -s ' ' | cut -d' ' -f7)

      if [ $current_node == "k8s-control-3" ]; then
        echo Plex running on quicksync node
        exit 0
      else
        echo Plex not running on quicksync node
      fi

      if [ $quicksync_available == "Ready" ]; then
        echo Quicksync node available
        kubectl -n media rollout restart deployment plex
        exit 0
      else
        echo Quicksync node unavailable
        exit 0
      fi
